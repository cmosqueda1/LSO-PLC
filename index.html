<script>
  // ===== AUTH STATE =====
  let authed = false;

  function setAuthed(state) {
    authed = !!state;
    const pill = document.getElementById("authPill");
    const runBtn = document.getElementById("runBtn");
    if (pill) pill.textContent = authed ? "Logged in" : "Not logged in";
    if (pill) pill.className = authed ? "pill" : "pill error";
    if (runBtn) runBtn.disabled = !authed;
  }

  function showError(msg) {
    const box = document.getElementById("errorBox");
    if (!box) return;
    if (!msg) { box.style.display = "none"; box.textContent = ""; return; }
    box.style.display = "block";
    box.textContent = msg;
  }

  async function callJson(url, bodyObj) {
    const res = await fetch(url, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bodyObj || {})
    });

    const text = await res.text();
    let json;
    try { json = JSON.parse(text); }
    catch {
      throw new Error(`Backend did not return JSON. HTTP ${res.status}. Body: ${text.slice(0, 200)}â€¦`);
    }

    if (!res.ok) {
      throw new Error(json?.error || json?.message || `HTTP ${res.status}`);
    }
    return json;
  }

  // ===== LOGIN =====
  async function login() {
    showError("");
    setAuthed(false);

    const username = (document.getElementById("username")?.value || "").trim();
    const password = (document.getElementById("password")?.value || "");

    if (!username || !password) {
      showError("Enter username and password.");
      return;
    }

    try {
      const r = await callJson("/api/init", { username, password });
      if (r?.ok === true) {
        setAuthed(true);
      } else {
        setAuthed(false);
        showError("Login failed (no ok:true returned).");
      }
    } catch (e) {
      setAuthed(false);
      showError(e?.message || String(e));
    }
  }

  // ===== SESSION REUSE ON LOAD =====
  async function tryReuseSession() {
    showError("");
    setAuthed(false);
    try {
      const r = await callJson("/api/init", {});
      if (r?.ok === true) setAuthed(true);
      else setAuthed(false);
    } catch {
      setAuthed(false);
    }
  }

  // ===== RUN QUERY (uses existing payload builder in your file) =====
  async function runQuery(payload) {
    showError("");
    if (!authed) {
      showError("Login required. Click Login first.");
      return null;
    }
    try {
      return await callJson("/api/results", payload);
    } catch (e) {
      // If backend says auth is missing/expired, force UI to reflect it
      const msg = e?.message || String(e);
      if (/login required|not authenticated|401/i.test(msg)) setAuthed(false);
      showError(msg);
      return null;
    }
  }

  // Wire buttons (keep IDs the same as your current file)
  document.getElementById("loginBtn")?.addEventListener("click", login);

  // On load, try to reuse existing session cookie
  tryReuseSession();

  // IMPORTANT:
  // Wherever your current code does the Run Query click handler,
  // change it to call runQuery(payload) and only render if result != null.
</script>
